name: Build and Deploy
on:
  push:
    branches: [main]


jobs:
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    outputs:
      container_app_url: ${{ steps.tf-output.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=${{ secrets.CODEX_PROJECT_ID }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -backend-config="client_secret=${{ secrets.AZURE_CLIENT_SECRET }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}"

      - name: Terraform Apply
        working-directory: terraform
        run: |
          terraform apply -auto-approve \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="sp_tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="sp_client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -var="sp_client_secret=${{ secrets.AZURE_CLIENT_SECRET }}" \
            -var="resource_group=${{ secrets.RESOURCE_GROUP }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="container_app_name=${{ secrets.CODEX_PROJECT_ID }}" \
            -var="container_apps_env_name=${{ secrets.CONTAINER_APPS_ENV }}" \
            -var="acr_name=${{ secrets.ACR_NAME }}" \
            -var="acr_login_server=${{ secrets.ACR_LOGIN_SERVER }}"

      - name: Get Terraform Outputs
        id: tf-output
        working-directory: terraform
        run: echo "url=$(terraform output -raw container_app_url)" >> $GITHUB_OUTPUT

  deploy:
    name: Build & Deploy from Source
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Build and Deploy to Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          appSourcePath: ${{ github.workspace }}
          acrName: ${{ secrets.ACR_NAME }}
          acrUsername: ${{ secrets.ACR_NAME }}
          acrPassword: ${{ secrets.ACR_PASSWORD }}
          containerAppName: ${{ secrets.CODEX_PROJECT_ID }}
          resourceGroup: ${{ secrets.RESOURCE_GROUP }}
          runtimeStack: "node:20"
          targetPort: 3000
